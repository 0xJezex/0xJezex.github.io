---
layout:     post
title:      "Curve v1 StableSwap code review"
subtitle:   "Curve v1 StableSwap code review"
date:       2022-02-12
author:     "0xmc"
header-img: "img/home-bg-o.jpg"
mathjax: true
tags:
    - Curve
    - code review 
---
## 前言
随着Defi行业将目光逐渐投向衍生品领域，许多报告和项目也应运而生，其中热度比较高的为paradigm的Everlasting Option和Power Perpetuals。本文介绍了永久期权和乘方合约以及如何从风险中性的角度对它们进行定价。

- 1. 永续期权内容介绍（主要内容，逻辑梳理，公式推导）
- 2. 乘方合约内容介绍（主要内容，逻辑梳理，公式推导）

## Everlasting Option
### Introducing the contract 
**Everlasting option: **永续期权是一种没有到期日的合约，根据目标（指数）价格和现行（标记）价格在多方和空方之间定期转移资金。这种机制允许任何传统衍生品以永续形式（无到期日）进行交易。该合约的行为类似于滚动的普通期权（有到期日）的投资组合，其中每个期权都在到期时被替换为到期日更晚的期权。资金费率为永续合约跟踪指数价格提供了激励。

我们将首先简要介绍最简单的期权类型，欧式期权。欧式期权有两种类型，看涨期权和看跌期权。
看涨期权赋予持有人在特定日期（到期日）的特定时间以特定价格（行使价）购买特定资产（标的资产）的权利。
看跌期权赋予持有人在到期时以行使价出售基础证券的权利。

例如，5 月 15 日的 3000 美元行使价 ETH 看跌期权赋予持有人在 5 月 15 日特定时间以 3000 美元的价格出售 1 个 ETH 的权利。 如果 5 月 15 日看跌期权到期时 ETH（现货）的交易价格为 2900 美元，交易者将能够在市场上以 2900 美元的价格买入 1 个 ETH，然后立即通过看跌期权以 3000 美元的价格卖出，锁定利润100 美元。这个数量被称为收益。 另一方面，如果交易者在 ETH 的价格为 3100 美元时持有 3000 美元的行使价，则交易者可以在市场上以高于她使用看跌期权的价格出售 ETH。在这种情况下，无法使用看跌期权获利，我们说收益为 0 美元。

尽管欧式期权只能在到期日的某个特定时刻使用或行使，但我们可以随时计算收益。它是衡量如果立即行使期权将值多少钱的指标。一般来说，看跌期权的收益是 max(strike-spot, 0)。 ETH 交易的价格越低，我们通过看跌期权卖出 ETH 赚的钱就越多。但是，如果 ETH 的价格在到期时高于行使价，那么直接在市场上卖出 ETH 比使用看跌期权要好，看跌期权毫无价值。

同样，看涨期权的收益为 max(spot - strike, 0)。如果 ETH 的交易价格为 3100 美元，而我们在到期时有 3000 美元的行使价 ETH 看涨期权，我们可以使用该看涨期权以 3000 美元的价格购买 ETH，然后立即以 3100 美元的价格在市场上出售，从而获得 100 美元的收益。但是，如果 ETH 的交易价格为 2900 美元，而我们有一个 3000 美元的 ETH 行权看涨期权，则收益为 0 美元。

期权在到期之前通常比其收益更有价值（不包括一些特殊情况）。 考虑一下明天到期的 3000 美元的 ETH 行使价。如果 ETH 的价格目前为 3000 美元，则该看跌期权的当前收益为 0 美元。但是明天 ETH 的价格可能会下跌，在这种情况下，看跌期权在到期时的价值将超过 0 美元。因此，现在看跌期权的价值必须大于 0 美元才能解释这种可能性。 一种基本且广泛使用的期权定价模型是 Black-Scholes 模型。下图显示了 3000 美元行使价 ETH 看跌期权的 Black-Scholes 价格与到期前一天各种现货 ETH 价格的收益相比。

期权的主要用例是对冲或防范风险。例如，如果投资者持有大量 ETH 投资组合，她可能会选择购买足够 3000 美元的行使价 ETH 看跌期权，以确保无论市场价格如何变化，她始终能够以每 ETH 至少 3000 美元的价格出售其头寸的 ETH。 然而，这些看跌期权最终将到期。如果投资者想保持对冲，她将不得不滚动她的期权头寸。在这种情况下，这意味着平仓即将到期的看跌期权头寸，并在稍后到期的具有相同行使价的看跌期权中开立新头寸。
然而对于传统期权来说，不断滚动头寸是一件代价高昂并且充满风险的事。为了防止与知情者交易造成高额亏损，做市商必须对每笔交易收取手续费，称为点差。因为知情交易对做市商来说成本很高，期权市场的点差往往特别高，这使得滚动头寸成为一项代价高昂的做法。 滚动头寸也涉及工作和风险。交易者可能忘记滚动，使她的头寸没有对冲。或者她可能会误点击或错误地执行交易，这可能既昂贵又危险。即使一切顺利，整个过程也会充满压力并且需要时间，从而将注意力从更有成效的工作中转移开。

同样的，对于套利者来说，如果说普通期权是多空双方关于股票价格的一次博弈，在到期日进行结算。那么永续期权则是多空双方对于股票价格的无限次博弈，并且在每个funding day进行结算，省去了多次建仓和平仓的操作。例如，假设ETH的现价为3000美元，投资者对于ETH未来的短期价格走势持乐观态度，但是又不确定这种乐观的预期会持续多久。而且手上资金不多，需要通过期权加杠杆。他可能会先购买明天到期的看涨期权，执行价格为3050美元。这样当ETH涨到3100美元时，可以使用该看涨期权以 3050 美元的价格购买 ETH，然后立即以 3100 美元的价格在市场上出售，从而获得 50 美元的收益。如果此时他认为ETH的价格还会上涨，他将需要继续购买看涨期权。在这种循环买卖的操作中，套利者分散了大量的时间和精力，同时也损失了很多手续费。

永续期权则可以解决上述问题，其工作方式如下：每天，做多永续期权（已买入）的人必须向做空 永续期权（已卖出）的人支付资金费用。该资金费用计算为（mark-index）：标记价格（永续期权的交易价格）与指数价格（标的物（如ETH）的价格）之间的差额。这种资金费用机制使得永续期权的价格与底层证券的价格保持一致。粗略地说，如果 永续期权变得比底层证券贵得多，那么多头将不得不支付高额的融资费用，这应该会激励他们出售 永续期权，从而降低其价格。借助这种机制，永续期权为交易者提供了长期的期权敞口，而无需额外花费时间和精力去滚动头寸，承担风险以及占用资金。
### Pricing
接下来本文将展示如果通过巧妙的构建一个等价资产组合，并利用无套利原则，从而借助一系列普通期权对永续期权进行间接定价。

首先我们对一系列的变量给出定义：

- SPOT – 底层证券的现行价格
- STRIKE – 期权的执行价格 
- PAYOFF – 永续衍生品所追踪的收益。对于永续期货来说，就是底层证券的现价，也就是SPOT。对于永续期权来说，就是max (SPOT _− _STRIKE_, _0)。
- $REGPRICE_t$– 常规的，也就是有到期日的衍生品，并且在未来时刻_t _的期望结算收益为PAYOFF。我们把这种衍生品定义为$REGDERIV_t$，其价格定义为$REGPRICE_t$。对于永续期货来说，就是到期日为_t_ 的常规期货的价格。对于永续期权来说，就是到期日为_t _的常规期权的价格。
- MARK – 在理想情况下，这就是永续衍生品在交易所的价格。 
- FUNDING FEE – 永续衍生品的多头向空头支付的费用(或者反过来，如果金额为负数)
- FUNDING PERIOD – 一次完整的funding fee支付完成的时间（比如一天）
- FUNDING FREQUENCY – 每个funding period中支付的次数 (举个例子, 如果funding period为一天，每小时支付一部分，那么funding frequency 就是24)。

交易者会在交易所里买卖永续衍生品，从而影响它的价格，也就是MARK。
FUNDING FEE由下式计算得出：
$FUNDING FEE=\frac{MARK-PAYOFF}{FUNDING FREQUENCY}$
假设$t_1, t_2, t_3 .....$为接下来的funding fee支付时间。例如，如果是1天支付24次的funding frequency，并且现在是8:30，则为$t_1, t_2, t_3$为9:00,10:00和11:00。
下面我们将证明永续期权的价格可以由如下公式给定：
$\frac{1}{FUNDING FREQUENCY} \sum_{i=1}^{\infty}(\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1})^{i}REGPRICE_{t_i}$

由于我们无法预测永续期权的未来现金流具体为多少，所以我们无法对其进行直接定价。这个时候就考虑到根据无套利原则，复制出一个等价的资产组合，对永续期权进行间接定价。我们的交易和操作需要与永续期权的现金流抵消为0，而永续期权的现金流主要为。
对于MARK，由于它是永续期权独有的价格，所以我们自然想到的操作是卖空永续期权。而对于PAYOFF，对于永续期权来说，是max (SPOT _− _STRIKE_, _0),也就是普通期权多方的结算收益，所以我们考虑做空普通期权。
假设下次的funding fee支付时间为$t$,我们持有a份永续期权，然后在在$t$时刻支付前的瞬间，卖空其中b比例的永续期权并且做多c份普通期权($t$时刻到期)来使未来现金流为0，那么我们手上剩余a*(1-b)份的永续期权。其中，卖空b比例的永续期权的收入为：$a*MARK*b$。由于我们做空c份的普通期权($t$时刻到期)，我们有义务在$t$时刻向多方支付$c*PAYOFF$，则在$t$时刻，我们的现金流(假设总和为0)：
$a*MARK*b-a*(1-b)\frac{MARK-PAYOFF}{FUNDING FREQUENCY}-c*PAYOFF=0$
解得：$b= \frac{a}{FREQUENCY+1}$，$c= \frac{a}{FREQUENCY+1}$

假设我们买入一份永续期权，并且卖出如下所示的一篮子普通期权：
$\frac{1}{FUNDING FREQUENCY} \sum_{i=1}^{\infty}(\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1})^{i}REGDERIV_{ti}$
在$t_1$时刻支付前的瞬间，我们卖出$\frac{1}{FUNDING FREQUENCY+1}$份的永续期权，手上还有$\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1}$份的永续期权。我们卖出永续期权的收入为：
$MARK*\frac{1}{FUNDING FREQUENCY+1}=\frac{MARK}{FUNDING FREQUENCY+1}$
根据手上剩余的永续期权头寸，我们需要在$t_1$时刻支付：
$\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1}*\frac{MARK-PAYOFF}{FUNDING FREQUENCY}=\frac{MARK-PAYOFF}{FUNDING FREQUENCY+1}$
同时，由于我们之前卖出的一篮子普通期权里包含在$t_1$时刻到期的$\frac{1}{FUNDING FREQUENCY+1}$份的$REGDERIV_{t_1}$，我们需要向多方支付：
$PAYOFF*\frac{1}{FUNDING FREQUENCY+1}=\frac{PAYOFF}{FUNDING FREQUENCY+1}$
总结一下，我们的现金流为：
$\frac{MARK}{FUNDING FREQUENCY+1}-\frac{MARK-PAYOFF}{FUNDING FREQUENCY+1}-\frac{PAYOFF}{FUNDING FREQUENCY+1}=0$
我们持有的永续期权和一篮子普通期权的头寸都被按比例削减到了原来的$\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1}$倍。在下一次支付时刻$t_2$前的瞬间，我们又可以进行上述操作，持有的永续期权和一篮子普通期权的头寸又会继续按$\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1}$比例进行削减。如此循环往复，即随着结算时刻的到来，不停的卖出永续期权和结算一篮子普通期权中到期的头寸，直至永续期权和一篮子普通期权的头寸清空（虽然从理论上来说只会无限接近于0）。由于每次操作都是在funding fee支付时间前的瞬间完成的，所以单次操作内mark和payoff都是同一时间的，mark和payoff是否随时间变化不影响上述推导。
根据无套利原则，既然未来的现金流一直为0，那么我们的投资组合在一开始的价格也应该为0，即一份永续期权的价格应当等于我们构造的一篮子普通期权的价格，也就是：
$\frac{1}{FUNDING FREQUENCY} \sum_{i=1}^{\infty}(\frac{FUNDING FREQUENCY}{FUNDING FREQUENCY+1})^{i}REGPRICE_{t_i}$
换句话说，永续期权等同于特定的不断滚动的普通期权投资组合，因此与该投资组合具有相同的价格。如果这些价格差异太大，套利者将介入以使它们恢复一致。 以每天支付一次funding fee为例（即funding frequency为1），这个等价的投资组合包括今天到期的期权合约的二分之一、明天到期的期权合约的四分之一、后天到期的期权合约的八分之一，以此类推。所有这些合约都与永续期权本身具有相同的执行价。
## Power perpetual
### Introducing the contract 
Power Future即乘方期货，是支付资产价格乘方的衍生品。例如，2-future在到期时支付资产价格的平方。乘方期货有效地概括了普通期货 ($price^1$) 和债券 ($price^0$)，并且可以在 Black-Scholes-Merton 或更一般的价格动态假设下定价。
** **Power Perpetual是永续形式的Power Future。从定价的角度来看，这是在每个funding period定价的一系列有固定到期日的乘方期货。在持续funding、波动率平滑的简单情况下，乘方永续合约的价格将接近在funding day到期的固定到期合约的价格。
Power Perpetual 是一种以某种标的工具的价格指数为指数的永续衍生工具。在本文中，我们将假设这个基础工具是以太币。对于任何幂 p，以$ETH^p$为标的的Power Perpetual通过定期支付funding fee（例如每天）与$ETH^p$的现价保持一致。如果在结算funding fee时 Power Perpetual 的当前价格是 MARK，那么做多 Power Perpetual 的人可能会向做空的人支付 $(MARK-INDEX) = (MARK-ETH^p )$。
在Power Perpetual的背景下，我们将此funding fee称为_溢价收益率_，以反映该成本通常代表从多头向空头支付的溢价，以换取类似期货的敞口。

考虑 ETH^2 的Power Perpetual。为简单起见，假设 ETH 的交易价格为 3 美元，而 ETH^2 永续合约在支付资金时的交易价格为 9.09 美元。然后多头（每份合约）必须支付空头 (MARK-INDEX) = (MARK-ETH^2) = (9.09 - 3^2) = 9.09 - 9.00 = $0.09 。
### Pricing
对$S^n$使用伊藤公式推导：
$dS^a=aS^{a-1}dS+\frac12a(a-1)S^{a-2}(\sigma S)^2dt=aS^a\frac{dS}{S}+\frac12a(a-1)S^{a}\sigma^2dt$
代入$\frac{dS}{S}=\mu dt+\sigma dB_t$:
$\frac{dS^a}{S^a}=(a\mu+\frac12a(a-1)\sigma^2)dt+a\sigma dB_t$
由此可以推出股票价格服从如下分布：
$S_T$~$lnN(lnS_t+(r+\frac12σ^2)(T−t),σ^2(T−t))$
同时根据k阶矩期望公式，对于对数正态分布$X∼lnN(μ,σ^2)$:
$E(X^k)=e^{kμ+\frac{k^2}{2}σ^2}$
我们推导出ETH^P的定价公式为：
$S^Pe^{t\frac{p-1}{2}(2r+pv^2)}$
其中 S 是现货价格，p 是幂，t 是到期时间，r 是漂移或无风险利率，v 是年化波动率。我们假设f 是以年为单位的funding period，并且每期结算1次（即funding frequency为1），则根据之前Everlasting Option的等比序列定价公式有：
$\frac{1}{1} \sum_{i=1}^{\infty}(\frac{1}{2})^{i}S^Pe^{(t+(i-1)f)\frac{p-1}{2}(2r+pv^2)}$
公比为$\frac12e^{f\frac{p-1}{2}(2r-pv^2)}$,当公比小于1时，上述等比数列收敛。求和得：
$S^P\frac{1}{2e^{-f\frac{p-1}{2}(2r-pv^2)}-1}$
此时funding fee可以计算为：
$MARK-INDEX=S^P(\frac{1}{2e^{-f\frac{p-1}{2}(2r-pv^2)}-1}-1)$
人为操纵f或许可以影响多空势力

没事哈，我先按照我的逻辑写。你没事看一下就好了，先休息养好~~20220714
我是尽量拆开分成2篇的哈，我放在notion里面。


















